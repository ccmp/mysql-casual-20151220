# Usage:
#  ansible-playbook -i ./hosts ./main.yml -vv
#

- hosts: dbs
  remote_user: root
  vars_files:
    - config.yml
    
  tasks:

  - get_url: url={{ item }} dest=/root/ mode=0440
    with_items:
#      - http://dev.mysql.com/get/mysql-apt-config_0.5.3-1_all.deb
      - http://dev.mysql.com/get/mysql-apt-config_0.8.10-1_all.deb

  - apt: update_cache=yes

  - apt: deb=/root/{{ item }} state=installed 
    with_items:
#      - mysql-apt-config_0.5.3-1_all.deb
      - mysql-apt-config_0.8.10-1_all.deb
    environment:
      DEBIAN_FRONTEND: "noninteractive"

  - debconf:
      name: mysql-apt-config
      question: mysql-apt-config/select-server
      value: "{{ mysql_select_server }}"
      vtype: select
      
  - copy: src=./files/{{ item.name }} dest={{ item.name }} mode={{ item.mode }}
    with_items:
#      - { name: '/etc/apt/sources.list.d/mysql.list', mode: '0644' }
      - { name: '/etc/apt/apt.conf', mode: '0644' }

  - apt: pkg={{ item }} state=present update_cache=yes
    with_items:
      - mysql-community-server

  - file: path={{ item.dir }} state=directory owner={{ item.owner }} group={{ item.group}} mode={{ item.mode }}
    with_items:
      - { dir: '/var/run/mysqld/', owner: 'mysql', group: 'mysql', mode: '0750' } 

  - template: src=./files/{{ item.name }} dest={{ item.name }} mode={{ item.mode }}
    with_items:
      - { name: '/etc/mysql/my.cnf', mode: '0644' }
    notify: restart-mysqld

  - copy: src=./files/{{ item.name }} dest={{ item.name }} mode={{ item.mode }}
    with_items:
      - { name: '/root/setup_master.sh', mode: '0700' }
      - { name: '/root/setup_slave.sh', mode: '0700' }

  - include: "./vrrp.yml"

  - include: "./xtrabackup.yml"

  - include: "./mariadb.yml"
#####

  handlers:

  - name: restart-mysqld
    service: name=mysql state=restarted enabled=yes

  - name: restart vrrp
    shell: /usr/bin/svc -t /etc/service/vrrp/

